---
title: "test"
author: "Maxwel Coura Oliveira"
date: "6/29/2020"
output: html_document
---

```{r include=FALSE}
library(tidyverse)
library(tidymodels)
library(purrr)
library(kableExtra)
library(tidytext)
```

```{r}
Data2 = read.csv("Soil2.csv")
glimpse(Data2)
```


```{r}
Data = read.csv("Soil1.csv")
glimpse(Data)
```

```{r}
sum(is.na(data))
```



```{r}
map(data, ~sum(is.na(.)))
```


```{r}
data <- Data2 %>% 
  filter(trt != "check") %>% 
   mutate_if(is.character, as.factor) #%>% 
#  filter(!is.na(biopercent))
```

```{r}
ggplot(data) + aes(y=biopercent, x=GDD) + geom_smooth(method="lm") + geom_point(alpha=0.1) +
  facet_grid(spec~trt) 
```

```{r}
lm_mod <- 
  linear_reg() %>% 
  set_engine("lm")
```


```{r}
lm_fit <- 
  lm_mod %>% 
  fit(biopercent ~ GDD * spec * trt, data = data)

tidy(lm_fit)
```


```{r}
# Here you select the GDD you want. For instance, if you want to see the residual at the end season, you add GDD>1000
new_points <- expand.grid(GDD = 900, 
                          trt = c("clas", "dual", "first", "out", "purs", "sharp", "spart", "tric", "valor", "war", "zid"), spec= c("fox", "pal", "rad", "rye"))
new_points
```

```{r}
#Getting predited values
mean_pred <- predict(lm_fit, new_data = new_points)
mean_pred
```

```{r}
#Getting conf intervals
conf_int_pred <- predict(lm_fit, 
                         new_data = new_points, 
                         type = "conf_int")
conf_int_pred
```




```{r}
# Plotting biomass (% untreated) at GDD = 1000 (your choice)
plot_data900 <- 
  new_points %>% 
  bind_cols(mean_pred) %>% 
  bind_cols(conf_int_pred)

# and plot:
ggplot(plot_data, aes(x = fct_reorder(trt, .pred))) + facet_grid(~spec) +
  geom_point(aes(y = .pred)) + coord_flip() +
  geom_errorbar(aes(ymin = .pred_lower, 
                    ymax = .pred_upper),
                width = .2) + 
  labs(y = "Biomass (% of untreated)")
```

```{r}
new_data <- rbind(plot_data100, plot_data500, plot_data900) %>% 
  mutate(trt = fct_recode(trt,
                          "chlorimuron-ethyl (2)" = "clas", 
                          "cloransulam-methyl (2)" = "first", 
                          "imazethapyr (2)" = "purs", 
                          "metribuzin (5)" = "tric", 
                          "sulfentrazone (14)" = "spart",  
                          "flumioxazin (14)" = "valor", 
                          "saflufenacil (14)" = "sharp", 
                          "dimethenamid-P (14)" = "out", 
                          "S-metolachlor (15)" = "dual", 
                          "acetochlor (15)" = "war", 
                          "pyroxasulfone (15)" = "zid")) %>% 
  mutate(species = fct_recode(spec,
                               "giant foxtail" = "fox",
                               "Palmer amaranth" = "pal",
                               "Radish" = "rad",
                               "Cereal rye" = "rye")) %>% 
  group_by(spec, GDD) %>% 
  mutate(GDD = as.factor(GDD),
           trt = fct_reorder(trt, .pred))
```


```{r}
p1 <- new_data %>% 
  filter(species == "Palmer amaranth") %>% 
  group_by(spec, GDD) %>% 
  mutate(GDD = as.factor(GDD),
           trt = reorder_within(trt, by = .pred, within = GDD)) %>% 
ggplot(aes(x = trt, y = .pred, color = .pred)) + 
  geom_point(size = 2, stroke= 1) + 
  scale_x_reordered() +
  scale_color_continuous(low = "red", high = "limegreen") +
  facet_grid(GDD ~ species, scales = "free") + 
  coord_flip() + 
  theme_bw() +
  scale_y_continuous(limits = c(-2,118), breaks = c(0 ,25, 50, 75, 100)) +
  geom_errorbar(aes(ymin = .pred_lower, 
                    ymax = .pred_upper),
                width = .2) + theme(panel.grid = element_blank()) +
  labs(x= "", y = "Biomass (% of untreated)") + 
  theme(legend.position = "none",
        strip.text = element_text(face = "bold", color = "black",
                                  size = 12),
        strip.background = element_rect(fill = "grey90")) +
  ggsave("Figure 6.pdf", width = 4, height = 6, dpi=600)
```

```{r}
p2 <- new_data %>% 
  filter(species == "giant foxtail") %>% 
  group_by(spec, GDD) %>% 
  mutate(GDD = as.factor(GDD),
           trt = reorder_within(trt, by = .pred, within = GDD)) %>% 
ggplot(aes(x = trt, y = .pred, color = .pred)) + 
  geom_point(size = 2, stroke= 1) + 
  scale_x_reordered() +
  scale_color_continuous(low = "red", high = "limegreen") +
  facet_grid(GDD ~ species, scales = "free") + 
  coord_flip() + 
  theme_bw() +
  scale_y_continuous(limits = c(-2,118), breaks = c(0 ,25, 50, 75, 100)) +
  geom_errorbar(aes(ymin = .pred_lower, 
                    ymax = .pred_upper),
                width = .2) + theme(panel.grid = element_blank()) +
  labs(x= "", y = "Biomass (% of untreated)") + 
  theme(legend.position = "none",
        strip.text = element_text(face = "bold", color = "black",
                                  size = 12),
        strip.background = element_rect(fill = "grey90")) +
  ggsave("Figure 7.pdf", width = 4, height = 6, dpi=600)
```

```{r}
expression(paste("No. of ", italic("bacteria X")))
```


```{r}
library(patchwork)

weeds <- p1 + p2 +
  ggsave("test.png")
```


```{r}
p3 <- new_data %>% 
  filter(species == "Radish") %>% 
  group_by(spec, GDD) %>% 
  mutate(GDD = as.factor(GDD),
           trt = reorder_within(trt, by = .pred, within = GDD)) %>% 
ggplot(aes(x = trt, y = .pred, color = .pred)) + 
  geom_point(size = 2, stroke= 1) +  
  scale_x_reordered() +
  scale_color_continuous(low = "red", high = "limegreen") +
  facet_grid(GDD ~ species, scales = "free") + 
  coord_flip() + 
  theme_bw() +
  scale_y_continuous(limits = c(-2,118), breaks = c(0 ,25, 50, 75, 100)) +
  geom_errorbar(aes(ymin = .pred_lower, 
                    ymax = .pred_upper),
                width = .2) + theme(panel.grid = element_blank()) +
  labs(x= "", y = "Biomass (% of untreated)") + 
  theme(legend.position = "none",
        strip.text = element_text(face = "bold", color = "black",
                                  size = 12),
        strip.background = element_rect(fill = "grey90")) +
  ggsave("Figure 8.pdf", width = 4, height = 6, dpi=600)
```

```{r}
p4 <- new_data %>% 
  filter(species == "Cereal rye") %>% 
  group_by(spec, GDD) %>% 
  mutate(GDD = as.factor(GDD),
           trt = reorder_within(trt, by = .pred, within = GDD)) %>% 
ggplot(aes(x = trt, y = .pred, color = .pred)) + 
  geom_point(size = 2, stroke= 1) + 
  scale_x_reordered() +
  scale_color_continuous(low = "red", high = "limegreen") +
  facet_grid(GDD ~ species, scales = "free") + 
  coord_flip() + 
  theme_bw() +
  scale_y_continuous(limits = c(-2,118), breaks = c(0 ,25, 50, 75, 100)) +
  geom_errorbar(aes(ymin = .pred_lower, 
                    ymax = .pred_upper),
                width = .2) + theme(panel.grid = element_blank()) +
  labs(x= "", y = "Biomass (% of untreated)") + 
  theme(legend.position = "none",
        strip.text = element_text(face = "bold", color = "black",
                                  size = 12),
        strip.background = element_rect(fill = "grey90")) +
  ggsave("Figure 9.pdf", width = 4, height = 6, dpi=600)
```


```{r}
crops <- p3 + p4 +
  ggsave("test1.png")
```

```{r}
(weeds | crops) +
  ggsave("test2.pdf", width = 15, height = 6, dpi = 600)
```



#Optimazing your model fit

```{r}
# Nesting data
nested_data <- data %>% 
  group_by(trt, spec) %>% 
  nest()

nested_data
```

```{r}
# Fitting linear models
nested_models <- nested_data %>% 
  mutate(model = map(data, ~ lm(biopercent ~ GDD, data = .x))) 
nested_models
```

```{r}
# Display estimated parameters, associated statistics, confidence intervals
nested_models %>% 
  mutate(coefs = map(model, tidy, conf.int = TRUE)) %>% 
  unnest(coefs)
```

```{r}
# Extracting R squared statistic for each model
nested_models %>% 
  mutate(metrics = map(model, glance)) %>% 
  unnest(metrics) %>% 
  select(trt:r.squared) %>% 
  arrange(desc(r.squared)) # Arranging by "best" R squared
```




